"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _1 = require(".");
const utils_1 = require("@grid-wolf/shared/utils");
let sendSpy;
let putCommandSpy;
let getCommandSpy;
let queryCommandSpy;
jest.mock('aws-xray-sdk', () => {
    return {
        captureAWSv3Client: (client) => client
    };
});
jest.mock('jsonwebtoken', () => {
    return {
        decode: () => ({ username: 'user' })
    };
});
jest.mock('@aws-sdk/client-dynamodb', () => {
    return {
        PutItemCommand: function (params) { return putCommandSpy(params); },
        GetItemCommand: function (params) { return getCommandSpy(params); },
        QueryCommand: function (params) { return queryCommandSpy(params); },
        DynamoDBClient: function () {
            return {
                send: (command) => sendSpy(command)
            };
        },
    };
});
describe('game handler', () => {
    let oldConsole;
    let Authorization;
    let gameDTO;
    let gameDAO;
    let event;
    beforeAll(() => {
        oldConsole = { ...console };
        console.warn = (message) => { };
    });
    beforeEach(() => {
        sendSpy = jest.fn().mockResolvedValue({});
        putCommandSpy = jest.fn().mockReturnValue({});
        getCommandSpy = jest.fn().mockReturnValue({});
        queryCommandSpy = jest.fn().mockReturnValue({});
        process.env[utils_1.EnvironmentVariableName.DATA_TABLE_NAME] = 'table';
        Authorization = `Bearer TOKEN`;
        gameDTO = {
            id: 'id',
            userId: 'user',
            name: 'name',
            timestamp: 1234
        };
        gameDAO = {
            pk: { S: 'user#user' },
            sk: { S: 'game#id' },
            id: { S: 'id' },
            userId: { S: 'user' },
            name: { S: 'name' },
            timestamp: { N: '1234' }
        };
        event = {
            body: JSON.stringify(gameDTO),
            requestContext: {
                httpMethod: 'PUT',
                resourcePath: '/game'
            },
            headers: {
                Authorization
            }
        };
    });
    afterAll(() => {
        console.warn = oldConsole.warn;
    });
    test('/game PUT should save game data to dynamodb', async () => {
        await expect((0, _1.handler)(event)).resolves.toEqual({
            statusCode: 202,
            body: 'accepted'
        });
        expect(putCommandSpy).toHaveBeenCalledWith({
            TableName: 'table',
            Item: gameDAO
        });
        expect(sendSpy).toHaveBeenCalledWith({});
    });
    test('/game PUT should return 401 if Authorized user does not match request body user', async () => {
        gameDTO.userId = 'otherperson';
        event.body = JSON.stringify(gameDTO);
        expect(await (0, _1.handler)(event)).toEqual({
            statusCode: 400,
            body: 'bad request'
        });
        expect(putCommandSpy).not.toHaveBeenCalled();
        expect(sendSpy).not.toHaveBeenCalled();
    });
    test('/game/{gameId} GET should return data obtained from dynamodb', async () => {
        event.requestContext.httpMethod = 'GET';
        event.requestContext.resourcePath = '/game/{gameId}';
        event.pathParameters = {
            gameId: 'id'
        };
        sendSpy.mockReturnValue({ Item: gameDAO });
        await expect((0, _1.handler)(event)).resolves.toEqual({
            statusCode: 200,
            body: JSON.stringify(gameDTO)
        });
        expect(getCommandSpy).toHaveBeenCalledWith({
            TableName: 'table',
            Key: {
                pk: { S: 'user#user' },
                sk: { S: 'game#id' }
            }
        });
        expect(sendSpy).toHaveBeenCalledWith({});
    });
    test('/game/{gameId} GET should return 403 error when game not found', async () => {
        event.requestContext.httpMethod = 'GET';
        event.requestContext.resourcePath = '/game/{gameId}';
        event.pathParameters = {
            gameId: 'id'
        };
        sendSpy.mockReturnValue({});
        await expect((0, _1.handler)(event)).resolves.toEqual({
            statusCode: 403,
            body: 'forbidden'
        });
    });
    test('/games GET should return a list of game data for the user', async () => {
        event.requestContext.resourcePath = '/games';
        event.requestContext.httpMethod = 'GET';
        sendSpy.mockReturnValue({ Items: [gameDAO] });
        await expect((0, _1.handler)(event)).resolves.toEqual({
            statusCode: 200,
            body: JSON.stringify([gameDTO])
        });
        expect(queryCommandSpy).toHaveBeenCalledWith({
            TableName: 'table',
            ExpressionAttributeValues: {
                ':pk': { S: 'user#user' }
            },
            KeyConditionExpression: 'pk = :pk'
        });
        expect(sendSpy).toHaveBeenCalledWith({});
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FtZS1oYW5kbGVyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnYW1lLWhhbmRsZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLHdCQUE0QjtBQUU1QixtREFBa0U7QUFFbEUsSUFBSSxPQUFrQixDQUFDO0FBQ3ZCLElBQUksYUFBd0IsQ0FBQztBQUM3QixJQUFJLGFBQXdCLENBQUM7QUFDN0IsSUFBSSxlQUEwQixDQUFDO0FBRS9CLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtJQUM3QixPQUFPO1FBQ0wsa0JBQWtCLEVBQUUsQ0FBQyxNQUFXLEVBQUUsRUFBRSxDQUFDLE1BQU07S0FDNUMsQ0FBQTtBQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0gsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO0lBQzdCLE9BQU87UUFDTCxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsQ0FBQztLQUNyQyxDQUFBO0FBQ0gsQ0FBQyxDQUFDLENBQUE7QUFDRixJQUFJLENBQUMsSUFBSSxDQUFDLDBCQUEwQixFQUFFLEdBQUcsRUFBRTtJQUN6QyxPQUFPO1FBQ0wsY0FBYyxFQUFFLFVBQVUsTUFBVyxJQUFJLE9BQU8sYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4RSxjQUFjLEVBQUUsVUFBVSxNQUFXLElBQUksT0FBTyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hFLFlBQVksRUFBRSxVQUFVLE1BQVcsSUFBSSxPQUFPLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEUsY0FBYyxFQUFFO1lBQ2QsT0FBTztnQkFDTCxJQUFJLEVBQUUsQ0FBQyxPQUFZLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7YUFDekMsQ0FBQTtRQUNILENBQUM7S0FD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QUNsQix5QkFBeUIsRUFBRTtnQkFDekIsS0FBSyxFQUFFLEVBQUUsQ0FBQyxFQUFFLFdBQVcsRUFBRTthQUMxQjtZQUNELHNCQUFzQixFQUFFLFVBQVU7U0FDbkMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLG9CQUFvQixDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQzFDLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCB9IGZyb20gXCJhd3MtbGFtYmRhXCI7XG5pbXBvcnQgeyBoYW5kbGVyIH0gZnJvbSBcIi5cIjtcbmltcG9ydCB7IEdhbWVEQU8sIEdhbWVEVE8gfSBmcm9tIFwiQGdyaWQtd29sZi9zaGFyZWQvZG9tYWluXCI7XG5pbXBvcnQgeyBFbnZpcm9ubWVudFZhcmlhYmxlTmFtZSB9IGZyb20gXCJAZ3JpZC13b2xmL3NoYXJlZC91dGlsc1wiO1xuXG5sZXQgc2VuZFNweTogamVzdC5Nb2NrO1xubGV0IHB1dENvbW1hbmRTcHk6IGplc3QuTW9jaztcbmxldCBnZXRDb21tYW5kU3B5OiBqZXN0Lk1vY2s7XG5sZXQgcXVlcnlDb21tYW5kU3B5OiBqZXN0Lk1vY2s7XG5cbmplc3QubW9jaygnYXdzLXhyYXktc2RrJywgKCkgPT4ge1xuICByZXR1cm4ge1xuICAgIGNhcHR1cmVBV1N2M0NsaWVudDogKGNsaWVudDogYW55KSA9PiBjbGllbnRcbiAgfVxufSk7XG5qZXN0Lm1vY2soJ2pzb253ZWJ0b2tlbicsICgpID0+IHtcbiAgcmV0dXJuIHtcbiAgICBkZWNvZGU6ICgpID0+ICh7IHVzZXJuYW1lOiAndXNlcicgfSlcbiAgfVxufSlcbmplc3QubW9jaygnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJywgKCkgPT4ge1xuICByZXR1cm4ge1xuICAgIFB1dEl0ZW1Db21tYW5kOiBmdW5jdGlvbiAocGFyYW1zOiBhbnkpIHsgcmV0dXJuIHB1dENvbW1hbmRTcHkocGFyYW1zKTsgfSxcbiAgICBHZXRJdGVtQ29tbWFuZDogZnVuY3Rpb24gKHBhcmFtczogYW55KSB7IHJldHVybiBnZXRDb21tYW5kU3B5KHBhcmFtcyk7IH0sXG4gICAgUXVlcnlDb21tYW5kOiBmdW5jdGlvbiAocGFyYW1zOiBhbnkpIHsgcmV0dXJuIHF1ZXJ5Q29tbWFuZFNweShwYXJhbXMpOyB9LFxuICAgIER5bmFtb0RCQ2xpZW50OiBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzZW5kOiAoY29tbWFuZDogYW55KSA9PiBzZW5kU3B5KGNvbW1hbmQpXG4gICAgICB9XG4gICAgfSxcbiAgfVxufSk7XG5cbmRlc2NyaWJlKCdnYW1lIGhhbmRsZXInLCAoKSA9PiB7XG4gIGxldCBvbGRDb25zb2xlOiBDb25zb2xlO1xuICBsZXQgQXV0aG9yaXphdGlvbjogc3RyaW5nO1xuICBsZXQgZ2FtZURUTzogR2FtZURUTztcbiAgbGV0IGdhbWVEQU86IEdhbWVEQU87XG4gIGxldCBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQ7XG5cbiAgYmVmb3JlQWxsKCgpID0+IHtcbiAgICBvbGRDb25zb2xlID0geyAuLi5jb25zb2xlIH07XG4gICAgY29uc29sZS53YXJuID0gKG1lc3NhZ2U6IHN0cmluZykgPT4ge307XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHNlbmRTcHkgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe30pO1xuICAgIHB1dENvbW1hbmRTcHkgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHt9KTtcbiAgICBnZXRDb21tYW5kU3B5ID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7fSk7XG4gICAgcXVlcnlDb21tYW5kU3B5ID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7fSk7XG4gICAgXG4gICAgcHJvY2Vzcy5lbnZbRW52aXJvbm1lbnRWYXJpYWJsZU5hbWUuREFUQV9UQUJMRV9OQU1FXSA9ICd0YWJsZSc7XG4gICAgQXV0aG9yaXphdGlvbiA9IGBCZWFyZXIgVE9LRU5gO1xuICAgIGdhbWVEVE8gPSB7XG4gICAgICBpZDogJ2lkJyxcbiAgICAgIHVzZXJJZDogJ3VzZXInLFxuICAgICAgbmFtZTogJ25hbWUnLFxuICAgICAgdGltZXN0YW1wOiAxMjM0XG4gICAgfTtcbiAgICBnYW1lREFPID0ge1xuICAgICAgcGs6IHsgUzogJ3VzZXIjdXNlcid9LFxuICAgICAgc2s6IHsgUzogJ2dhbWUjaWQnfSxcbiAgICAgIGlkOiB7IFM6ICdpZCcgfSxcbiAgICAgIHVzZXJJZDogeyBTOiAndXNlcicgfSxcbiAgICAgIG5hbWU6IHsgUzogJ25hbWUnIH0sXG4gICAgICB0aW1lc3RhbXA6IHsgTjogJzEyMzQnIH1cbiAgICB9O1xuICAgIGV2ZW50ID0ge1xuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoZ2FtZURUTyksXG4gICAgICByZXF1ZXN0Q29udGV4dDoge1xuICAgICAgICBodHRwTWV0aG9kOiAnUFVUJyxcbiAgICAgICAgcmVzb3VyY2VQYXRoOiAnL2dhbWUnXG4gICAgICB9LFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICBBdXRob3JpemF0aW9uXG4gICAgICB9XG4gICAgfSBhcyBhbnkgYXMgQVBJR2F0ZXdheVByb3h5RXZlbnRcbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoKCkgPT4ge1xuICAgIGNvbnNvbGUud2FybiA9IG9sZENvbnNvbGUud2FybjtcbiAgfSk7XG5cbiAgdGVzdCgnL2dhbWUgUFVUIHNob3VsZCBzYXZlIGdhbWUgZGF0YSB0byBkeW5hbW9kYicsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBleHBlY3QoaGFuZGxlcihldmVudCkpLnJlc29sdmVzLnRvRXF1YWwoe1xuICAgICAgc3RhdHVzQ29kZTogMjAyLFxuICAgICAgYm9keTogJ2FjY2VwdGVkJ1xuICAgIH0pO1xuICAgIGV4cGVjdChwdXRDb21tYW5kU3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICBUYWJsZU5hbWU6ICd0YWJsZScsXG4gICAgICBJdGVtOiBnYW1lREFPXG4gICAgfSk7XG4gICAgZXhwZWN0KHNlbmRTcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHt9KTtcbiAgfSk7XG5cbiAgdGVzdCgnL2dhbWUgUFVUIHNob3VsZCByZXR1cm4gNDAxIGlmIEF1dGhvcml6ZWQgdXNlciBkb2VzIG5vdCBtYXRjaCByZXF1ZXN0IGJvZHkgdXNlcicsIGFzeW5jICgpID0+IHtcbiAgICBnYW1lRFRPLnVzZXJJZCA9ICdvdGhlcnBlcnNvbic7XG4gICAgZXZlbnQuYm9keSA9IEpTT04uc3RyaW5naWZ5KGdhbWVEVE8pO1xuXG4gICAgZXhwZWN0KGF3YWl0IGhhbmRsZXIoZXZlbnQpKS50b0VxdWFsKHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIGJvZHk6ICdiYWQgcmVxdWVzdCdcbiAgICB9KTtcblxuICAgIGV4cGVjdChwdXRDb21tYW5kU3B5KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIGV4cGVjdChzZW5kU3B5KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICB9KTtcblxuICB0ZXN0KCcvZ2FtZS97Z2FtZUlkfSBHRVQgc2hvdWxkIHJldHVybiBkYXRhIG9idGFpbmVkIGZyb20gZHluYW1vZGInLCBhc3luYyAoKSA9PiB7XG4gICAgZXZlbnQucmVxdWVzdENvbnRleHQuaHR0cE1ldGhvZCA9ICdHRVQnO1xuICAgIGV2ZW50LnJlcXVlc3RDb250ZXh0LnJlc291cmNlUGF0aCA9ICcvZ2FtZS97Z2FtZUlkfSc7XG4gICAgZXZlbnQucGF0aFBhcmFtZXRlcnMgPSB7XG4gICAgICBnYW1lSWQ6ICdpZCdcbiAgICB9O1xuICAgIHNlbmRTcHkubW9ja1JldHVyblZhbHVlKHsgSXRlbTogZ2FtZURBTyB9KTtcblxuICAgIGF3YWl0IGV4cGVjdChoYW5kbGVyKGV2ZW50KSkucmVzb2x2ZXMudG9FcXVhbCh7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShnYW1lRFRPKVxuICAgIH0pO1xuXG4gICAgZXhwZWN0KGdldENvbW1hbmRTcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgIFRhYmxlTmFtZTogJ3RhYmxlJyxcbiAgICAgIEtleToge1xuICAgICAgICBwazogeyBTOiAndXNlciN1c2VyJyB9LFxuICAgICAgICBzazogeyBTOiAnZ2FtZSNpZCd9XG4gICAgICB9XG4gICAgfSk7XG4gICAgZXhwZWN0KHNlbmRTcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHt9KTtcbiAgfSk7XG5cbiAgdGVzdCgnL2dhbWUve2dhbWVJZH0gR0VUIHNob3VsZCByZXR1cm4gNDAzIGVycm9yIHdoZW4gZ2FtZSBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XG4gICAgZXZlbnQucmVxdWVzdENvbnRleHQuaHR0cE1ldGhvZCA9ICdHRVQnO1xuICAgIGV2ZW50LnJlcXVlc3RDb250ZXh0LnJlc291cmNlUGF0aCA9ICcvZ2FtZS97Z2FtZUlkfSc7XG4gICAgZXZlbnQucGF0aFBhcmFtZXRlcnMgPSB7XG4gICAgICBnYW1lSWQ6ICdpZCdcbiAgICB9O1xuICAgIHNlbmRTcHkubW9ja1JldHVyblZhbHVlKHt9KTtcblxuICAgIGF3YWl0IGV4cGVjdChoYW5kbGVyKGV2ZW50KSkucmVzb2x2ZXMudG9FcXVhbCh7XG4gICAgICBzdGF0dXNDb2RlOiA0MDMsXG4gICAgICBib2R5OiAnZm9yYmlkZGVuJ1xuICAgIH0pXG4gIH0pO1xuXG4gIHRlc3QoJy9nYW1lcyBHRVQgc2hvdWxkIHJldHVybiBhIGxpc3Qgb2YgZ2FtZSBkYXRhIGZvciB0aGUgdXNlcicsIGFzeW5jICgpID0+IHtcbiAgICBldmVudC5yZXF1ZXN0Q29udGV4dC5yZXNvdXJjZVBhdGggPSAnL2dhbWVzJ1xuICAgIGV2ZW50LnJlcXVlc3RDb250ZXh0Lmh0dHBNZXRob2QgPSAnR0VUJ1xuICAgIHNlbmRTcHkubW9ja1JldHVyblZhbHVlKHsgSXRlbXM6IFsgZ2FtZURBTyBdIH0pO1xuXG4gICAgYXdhaXQgZXhwZWN0KGhhbmRsZXIoZXZlbnQpKS5yZXNvbHZlcy50b0VxdWFsKHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KFsgZ2FtZURUTyBdKVxuICAgIH0pO1xuICAgIGV4cGVjdChxdWVyeUNvbW1hbmRTcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgIFRhYmxlTmFtZTogJ3RhYmxlJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpwayc6IHsgUzogJ3VzZXIjdXNlcicgfVxuICAgICAgfSxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwayA9IDpwaydcbiAgICB9KTtcbiAgICBleHBlY3Qoc2VuZFNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe30pXG4gIH0pO1xufSk7XG4iXX0=