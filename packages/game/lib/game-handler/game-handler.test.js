"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _1 = require(".");
const utils_1 = require("@grid-wolf/shared/utils");
let sendSpy;
let putCommandSpy;
let getCommandSpy;
let queryCommandSpy;
jest.mock('aws-xray-sdk', () => {
    return {
        captureAWSv3Client: (client) => client
    };
});
jest.mock('jsonwebtoken', () => {
    return {
        decode: (token) => ({ username: 'user' })
    };
});
jest.mock('@aws-sdk/client-dynamodb', () => {
    return {
        PutItemCommand: function (params) { return putCommandSpy(params); },
        GetItemCommand: function (params) { return getCommandSpy(params); },
        QueryCommand: function (params) { return queryCommandSpy(params); },
        DynamoDBClient: function () {
            return {
                send: (command) => sendSpy(command)
            };
        },
    };
});
describe('game handler', () => {
    let oldConsole;
    let Authorization;
    let gameDTO;
    let gameDAO;
    let event;
    beforeAll(() => {
        oldConsole = { ...console };
        console.warn = (message) => { };
    });
    beforeEach(() => {
        sendSpy = jest.fn().mockResolvedValue({});
        putCommandSpy = jest.fn().mockReturnValue({});
        getCommandSpy = jest.fn().mockReturnValue({});
        queryCommandSpy = jest.fn().mockReturnValue({});
        process.env[utils_1.EnvironmentVariableName.DATA_TABLE_NAME] = 'table';
        Authorization = `Bearer TOKEN`;
        gameDTO = {
            id: 'id',
            userId: 'user',
            name: 'name',
            timestamp: 1234
        };
        gameDAO = {
            pk: { S: 'user#user' },
            sk: { S: 'game#id' },
            id: { S: 'id' },
            userId: { S: 'user' },
            name: { S: 'name' },
            timestamp: { N: '1234' }
        };
        event = {
            body: JSON.stringify(gameDTO),
            requestContext: {
                httpMethod: 'GET',
                path: '/game'
            },
            headers: {
                Authorization
            }
        };
    });
    afterAll(() => {
        console.warn = oldConsole.warn;
    });
    test('/game PUT should save game data to dynamodb', async () => {
        event.requestContext.httpMethod = 'PUT';
        await expect((0, _1.handler)(event)).resolves.toEqual({
            statusCode: 202,
            message: 'accepted'
        });
        expect(putCommandSpy).toHaveBeenCalledWith({
            TableName: 'table',
            Item: gameDAO
        });
        expect(sendSpy).toHaveBeenCalledWith({});
    });
    test('/game PUT should return 401 if Authorized user does not match request body user', async () => {
        event.requestContext.httpMethod = 'PUT';
        gameDTO.userId = 'otherperson';
        event.body = JSON.stringify(gameDTO);
        expect(await (0, _1.handler)(event)).toEqual({
            statusCode: 400,
            message: 'bad request'
        });
        expect(putCommandSpy).not.toHaveBeenCalled();
        expect(sendSpy).not.toHaveBeenCalled();
    });
    test('/game/{gameId} GET should return data obtained from dynamodb', async () => {
        event.pathParameters = {
            gameId: 'id'
        };
        sendSpy.mockReturnValue({ Item: gameDAO });
        await expect((0, _1.handler)(event)).resolves.toEqual({
            statusCode: 200,
            body: JSON.stringify(gameDTO)
        });
        expect(getCommandSpy).toHaveBeenCalledWith({
            TableName: 'table',
            Key: {
                pk: { S: 'user#user' },
                sk: { S: 'game#id' }
            }
        });
        expect(sendSpy).toHaveBeenCalledWith({});
    });
    test('/games GET should return a list of game data for the user', async () => {
        event.requestContext.path = '/games';
        event.requestContext.httpMethod = 'GET';
        sendSpy.mockReturnValue({ Items: [gameDAO] });
        await expect((0, _1.handler)(event)).resolves.toEqual({
            statusCode: 200,
            body: JSON.stringify([gameDTO])
        });
        expect(queryCommandSpy).toHaveBeenCalledWith({
            TableName: 'table',
            ExpressionAttributeValues: {
                ':pk': { S: 'user#user' }
            },
            KeyConditionExpression: 'pk = :pk'
        });
        expect(sendSpy).toHaveBeenCalledWith({});
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FtZS1oYW5kbGVyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnYW1lLWhhbmRsZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLHdCQUE0QjtBQUU1QixtREFBa0U7QUFFbEUsSUFBSSxPQUFrQixDQUFDO0FBQ3ZCLElBQUksYUFBd0IsQ0FBQztBQUM3QixJQUFJLGFBQXdCLENBQUM7QUFDN0IsSUFBSSxlQUEwQixDQUFDO0FBRS9CLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtJQUM3QixPQUFPO1FBQ0wsa0JBQWtCLEVBQUUsQ0FBQyxNQUFXLEVBQUUsRUFBRSxDQUFDLE1BQU07S0FDNUMsQ0FBQTtBQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0gsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO0lBQzdCLE9BQU87UUFDTCxNQUFNLEVBQUUsQ0FBQyxLQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLENBQUM7S0FDbEQsQ0FBQTtBQUNILENBQUMsQ0FBQyxDQUFBO0FBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQywwQkFBMEIsRUFBRSxHQUFHLEVBQUU7SUFDekMsT0FBTztRQUNMLGNBQWMsRUFBRSxVQUFVLE1BQVcsSUFBSSxPQUFPLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEUsY0FBYyxFQUFFLFVBQVUsTUFBVyxJQUFJLE9BQU8sYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4RSxZQUFZLEVBQUUsVUFBVSxNQUFXLElBQUksT0FBTyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hFLGNBQWMsRUFBRTtZQUNkLE9BQU87Z0JBQ0wsSUFBSSxFQUFFLENBQUMsT0FBWSxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDO2FBQ3pDLENBQUE7UUFD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LENBQUM7UUFDSCxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsb0JBQW9CLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDM0MsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsMkRBQTJELEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDM0UsS0FBSyxDQUFDLGNBQWMsQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFBO1FBQ3BDLEtBQUssQ0FBQyxjQUFjLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQTtRQUN2QyxPQUFPLENBQUMsZUFBZSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUUsT0FBTyxDQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWhELE1BQU0sTUFBTSxDQUFDLElBQUEsVUFBTyxFQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQztZQUM1QyxVQUFVLEVBQUUsR0FBRztZQUNmLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUUsT0FBTyxDQUFFLENBQUM7U0FDbEMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLG9CQUFvQixDQUFDO1lBQzNDLFNBQVMsRUFBRSxPQUFPO1lBQ2xCLHlCQUF5QixFQUFFO2dCQUN6QixLQUFLLEVBQUUsRUFBRSxDQUFDLEVBQUUsV0FBVyxFQUFFO2FBQzFCO1lBQ0Qsc0JBQXNCLEVBQUUsVUFBVTtTQUNuQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsb0JBQW9CLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDMUMsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50IH0gZnJvbSBcImF3cy1sYW1iZGFcIjtcbmltcG9ydCB7IGhhbmRsZXIgfSBmcm9tIFwiLlwiO1xuaW1wb3J0IHsgR2FtZURBTywgR2FtZURUTyB9IGZyb20gXCJAZ3JpZC13b2xmL3NoYXJlZC9kb21haW5cIjtcbmltcG9ydCB7IEVudmlyb25tZW50VmFyaWFibGVOYW1lIH0gZnJvbSBcIkBncmlkLXdvbGYvc2hhcmVkL3V0aWxzXCI7XG5cbmxldCBzZW5kU3B5OiBqZXN0Lk1vY2s7XG5sZXQgcHV0Q29tbWFuZFNweTogamVzdC5Nb2NrO1xubGV0IGdldENvbW1hbmRTcHk6IGplc3QuTW9jaztcbmxldCBxdWVyeUNvbW1hbmRTcHk6IGplc3QuTW9jaztcblxuamVzdC5tb2NrKCdhd3MteHJheS1zZGsnLCAoKSA9PiB7XG4gIHJldHVybiB7XG4gICAgY2FwdHVyZUFXU3YzQ2xpZW50OiAoY2xpZW50OiBhbnkpID0+IGNsaWVudFxuICB9XG59KTtcbmplc3QubW9jaygnanNvbndlYnRva2VuJywgKCkgPT4ge1xuICByZXR1cm4ge1xuICAgIGRlY29kZTogKHRva2VuOiBzdHJpbmcpID0+ICh7IHVzZXJuYW1lOiAndXNlcicgfSlcbiAgfVxufSlcbmplc3QubW9jaygnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJywgKCkgPT4ge1xuICByZXR1cm4ge1xuICAgIFB1dEl0ZW1Db21tYW5kOiBmdW5jdGlvbiAocGFyYW1zOiBhbnkpIHsgcmV0dXJuIHB1dENvbW1hbmRTcHkocGFyYW1zKTsgfSxcbiAgICBHZXRJdGVtQ29tbWFuZDogZnVuY3Rpb24gKHBhcmFtczogYW55KSB7IHJldHVybiBnZXRDb21tYW5kU3B5KHBhcmFtcyk7IH0sXG4gICAgUXVlcnlDb21tYW5kOiBmdW5jdGlvbiAocGFyYW1zOiBhbnkpIHsgcmV0dXJuIHF1ZXJ5Q29tbWFuZFNweShwYXJhbXMpOyB9LFxuICAgIER5bmFtb0RCQ2xpZW50OiBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzZW5kOiAoY29tbWFuZDogYW55KSA9PiBzZW5kU3B5KGNvbW1hbmQpXG4gICAgICB9XG4gICAgfSxcbiAgfVxufSk7XG5cbmRlc2NyaWJlKCdnYW1lIGhhbmRsZXInLCAoKSA9PiB7XG4gIGxldCBvbGRDb25zb2xlOiBDb25zb2xlO1xuICBsZXQgQXV0aG9yaXphdGlvbjogc3RyaW5nO1xuICBsZXQgZ2FtZURUTzogR2FtZURUTztcbiAgbGV0IGdhbWVEQU86IEdhbWVEQU87XG4gIGxldCBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQ7XG5cbiAgYmVmb3JlQWxsKCgpID0+IHtcbiAgICBvbGRDb25zb2xlID0geyAuLi5jb25zb2xlIH07XG4gICAgY29uc29sZS53YXJuID0gKG1lc3NhZ2U6IHN0cmluZykgPT4ge307XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHNlbmRTcHkgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe30pO1xuICAgIHB1dENvbW1hbmRTcHkgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHt9KTtcbiAgICBnZXRDb21tYW5kU3B5ID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7fSk7XG4gICAgcXVlcnlDb21tYW5kU3B5ID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7fSk7XG4gICAgXG4gICAgcHJvY2Vzcy5lbnZbRW52aXJvbm1lbnRWYXJpYWJsZU5hbWUuREFUQV9UQUJMRV9OQU1FXSA9ICd0YWJsZSc7XG4gICAgQXV0aG9yaXphdGlvbiA9IGBCZWFyZXIgVE9LRU5gO1xuICAgIGdhbWVEVE8gPSB7XG4gICAgICBpZDogJ2lkJyxcbiAgICAgIHVzZXJJZDogJ3VzZXInLFxuICAgICAgbmFtZTogJ25hbWUnLFxuICAgICAgdGltZXN0YW1wOiAxMjM0XG4gICAgfTtcbiAgICBnYW1lREFPID0ge1xuICAgICAgcGs6IHsgUzogJ3VzZXIjdXNlcid9LFxuICAgICAgc2s6IHsgUzogJ2dhbWUjaWQnfSxcbiAgICAgIGlkOiB7IFM6ICdpZCcgfSxcbiAgICAgIHVzZXJJZDogeyBTOiAndXNlcicgfSxcbiAgICAgIG5hbWU6IHsgUzogJ25hbWUnIH0sXG4gICAgICB0aW1lc3RhbXA6IHsgTjogJzEyMzQnIH1cbiAgICB9O1xuICAgIGV2ZW50ID0ge1xuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoZ2FtZURUTyksXG4gICAgICByZXF1ZXN0Q29udGV4dDoge1xuICAgICAgICBodHRwTWV0aG9kOiAnR0VUJyxcbiAgICAgICAgcGF0aDogJy9nYW1lJ1xuICAgICAgfSxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgQXV0aG9yaXphdGlvblxuICAgICAgfVxuICAgIH0gYXMgYW55IGFzIEFQSUdhdGV3YXlQcm94eUV2ZW50XG4gIH0pO1xuXG4gIGFmdGVyQWxsKCgpID0+IHtcbiAgICBjb25zb2xlLndhcm4gPSBvbGRDb25zb2xlLndhcm47XG4gIH0pO1xuXG4gIHRlc3QoJy9nYW1lIFBVVCBzaG91bGQgc2F2ZSBnYW1lIGRhdGEgdG8gZHluYW1vZGInLCBhc3luYyAoKSA9PiB7XG4gICAgZXZlbnQucmVxdWVzdENvbnRleHQuaHR0cE1ldGhvZCA9ICdQVVQnO1xuICAgIGF3YWl0IGV4cGVjdChoYW5kbGVyKGV2ZW50KSkucmVzb2x2ZXMudG9FcXVhbCh7XG4gICAgICBzdGF0dXNDb2RlOiAyMDIsXG4gICAgICBtZXNzYWdlOiAnYWNjZXB0ZWQnXG4gICAgfSk7XG4gICAgZXhwZWN0KHB1dENvbW1hbmRTcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgIFRhYmxlTmFtZTogJ3RhYmxlJyxcbiAgICAgIEl0ZW06IGdhbWVEQU9cbiAgICB9KTtcbiAgICBleHBlY3Qoc2VuZFNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe30pO1xuICB9KTtcblxuICB0ZXN0KCcvZ2FtZSBQVVQgc2hvdWxkIHJldHVybiA0MDEgaWYgQXV0aG9yaXplZCB1c2VyIGRvZXMgbm90IG1hdGNoIHJlcXVlc3QgYm9keSB1c2VyJywgYXN5bmMgKCkgPT4ge1xuICAgIGV2ZW50LnJlcXVlc3RDb250ZXh0Lmh0dHBNZXRob2QgPSAnUFVUJztcbiAgICBnYW1lRFRPLnVzZXJJZCA9ICdvdGhlcnBlcnNvbic7XG4gICAgZXZlbnQuYm9keSA9IEpTT04uc3RyaW5naWZ5KGdhbWVEVE8pO1xuXG4gICAgZXhwZWN0KGF3YWl0IGhhbmRsZXIoZXZlbnQpKS50b0VxdWFsKHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIG1lc3NhZ2U6ICdiYWQgcmVxdWVzdCdcbiAgICB9KTtcblxuICAgIGV4cGVjdChwdXRDb21tYW5kU3B5KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIGV4cGVjdChzZW5kU3B5KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICB9KTtcblxuICB0ZXN0KCcvZ2FtZS97Z2FtZUlkfSBHRVQgc2hvdWxkIHJldHVybiBkYXRhIG9idGFpbmVkIGZyb20gZHluYW1vZGInLCBhc3luYyAoKSA9PiB7XG4gICAgZXZlbnQucGF0aFBhcmFtZXRlcnMgPSB7XG4gICAgICBnYW1lSWQ6ICdpZCdcbiAgICB9O1xuICAgIHNlbmRTcHkubW9ja1JldHVyblZhbHVlKHsgSXRlbTogZ2FtZURBTyB9KTtcblxuICAgIGF3YWl0IGV4cGVjdChoYW5kbGVyKGV2ZW50KSkucmVzb2x2ZXMudG9FcXVhbCh7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShnYW1lRFRPKVxuICAgIH0pO1xuXG4gICAgZXhwZWN0KGdldENvbW1hbmRTcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgIFRhYmxlTmFtZTogJ3RhYmxlJyxcbiAgICAgIEtleToge1xuICAgICAgICBwazogeyBTOiAndXNlciN1c2VyJyB9LFxuICAgICAgICBzazogeyBTOiAnZ2FtZSNpZCd9XG4gICAgICB9XG4gICAgfSk7XG4gICAgZXhwZWN0KHNlbmRTcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHt9KTtcbiAgfSk7XG5cbiAgdGVzdCgnL2dhbWVzIEdFVCBzaG91bGQgcmV0dXJuIGEgbGlzdCBvZiBnYW1lIGRhdGEgZm9yIHRoZSB1c2VyJywgYXN5bmMgKCkgPT4ge1xuICAgIGV2ZW50LnJlcXVlc3RDb250ZXh0LnBhdGggPSAnL2dhbWVzJ1xuICAgIGV2ZW50LnJlcXVlc3RDb250ZXh0Lmh0dHBNZXRob2QgPSAnR0VUJ1xuICAgIHNlbmRTcHkubW9ja1JldHVyblZhbHVlKHsgSXRlbXM6IFsgZ2FtZURBTyBdIH0pO1xuXG4gICAgYXdhaXQgZXhwZWN0KGhhbmRsZXIoZXZlbnQpKS5yZXNvbHZlcy50b0VxdWFsKHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KFsgZ2FtZURUTyBdKVxuICAgIH0pO1xuICAgIGV4cGVjdChxdWVyeUNvbW1hbmRTcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgIFRhYmxlTmFtZTogJ3RhYmxlJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpwayc6IHsgUzogJ3VzZXIjdXNlcicgfVxuICAgICAgfSxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwayA9IDpwaydcbiAgICB9KTtcbiAgICBleHBlY3Qoc2VuZFNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe30pXG4gIH0pO1xufSk7XG4iXX0=