"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _1 = require(".");
const utils_1 = require("@grid-wolf/shared/utils");
let sendSpy;
let putCommandSpy;
let getCommandSpy;
let queryCommandSpy;
jest.mock('aws-xray-sdk', () => {
    return {
        captureAWSv3Client: (client) => client
    };
});
jest.mock('jsonwebtoken', () => {
    return {
        decode: () => ({ username: 'user' })
    };
});
jest.mock('@aws-sdk/client-dynamodb', () => {
    return {
        PutItemCommand: function (params) { return putCommandSpy(params); },
        GetItemCommand: function (params) { return getCommandSpy(params); },
        QueryCommand: function (params) { return queryCommandSpy(params); },
        DynamoDBClient: function () {
            return {
                send: (command) => sendSpy(command)
            };
        },
    };
});
describe('game handler', () => {
    let oldConsole;
    let Authorization;
    let gameDTO;
    let gameDAO;
    let event;
    beforeAll(() => {
        oldConsole = { ...console };
        console.warn = (message) => { };
    });
    beforeEach(() => {
        sendSpy = jest.fn().mockResolvedValue({});
        putCommandSpy = jest.fn().mockReturnValue({});
        getCommandSpy = jest.fn().mockReturnValue({});
        queryCommandSpy = jest.fn().mockReturnValue({});
        process.env[utils_1.EnvironmentVariableName.DATA_TABLE_NAME] = 'table';
        Authorization = `Bearer TOKEN`;
        gameDTO = {
            id: 'id',
            userId: 'user',
            name: 'name',
            timestamp: 1234
        };
        gameDAO = {
            pk: { S: 'user#user' },
            sk: { S: 'game#id' },
            id: { S: 'id' },
            userId: { S: 'user' },
            name: { S: 'name' },
            timestamp: { N: '1234' }
        };
        event = {
            body: JSON.stringify(gameDTO),
            requestContext: {
                httpMethod: 'PUT',
                resourcePath: '/game'
            },
            headers: {
                Authorization
            }
        };
    });
    afterAll(() => {
        console.warn = oldConsole.warn;
    });
    test('/game PUT should save game data to dynamodb', async () => {
        await expect((0, _1.handler)(event)).resolves.toEqual({
            statusCode: 202,
            body: 'accepted'
        });
        expect(putCommandSpy).toHaveBeenCalledWith({
            TableName: 'table',
            Item: gameDAO
        });
        expect(sendSpy).toHaveBeenCalledWith({});
    });
    test('/game PUT should return 401 if Authorized user does not match request body user', async () => {
        gameDTO.userId = 'otherperson';
        event.body = JSON.stringify(gameDTO);
        expect(await (0, _1.handler)(event)).toEqual({
            statusCode: 400,
            body: 'bad request'
        });
        expect(putCommandSpy).not.toHaveBeenCalled();
        expect(sendSpy).not.toHaveBeenCalled();
    });
    test('/game/{gameId} GET should return data obtained from dynamodb', async () => {
        event.requestContext.httpMethod = 'GET';
        event.requestContext.resourcePath = '/game/{gameId}';
        event.pathParameters = {
            gameId: 'id'
        };
        sendSpy.mockReturnValue({ Item: gameDAO });
        await expect((0, _1.handler)(event)).resolves.toEqual({
            statusCode: 200,
            body: JSON.stringify(gameDTO)
        });
        expect(getCommandSpy).toHaveBeenCalledWith({
            TableName: 'table',
            Key: {
                pk: { S: 'user#user' },
                sk: { S: 'game#id' }
            }
        });
        expect(sendSpy).toHaveBeenCalledWith({});
    });
    test('/games GET should return a list of game data for the user', async () => {
        event.requestContext.resourcePath = '/games';
        event.requestContext.httpMethod = 'GET';
        sendSpy.mockReturnValue({ Items: [gameDAO] });
        await expect((0, _1.handler)(event)).resolves.toEqual({
            statusCode: 200,
            body: JSON.stringify([gameDTO])
        });
        expect(queryCommandSpy).toHaveBeenCalledWith({
            TableName: 'table',
            ExpressionAttributeValues: {
                ':pk': { S: 'user#user' }
            },
            KeyConditionExpression: 'pk = :pk'
        });
        expect(sendSpy).toHaveBeenCalledWith({});
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FtZS1oYW5kbGVyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnYW1lLWhhbmRsZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLHdCQUE0QjtBQUU1QixtREFBa0U7QUFFbEUsSUFBSSxPQUFrQixDQUFDO0FBQ3ZCLElBQUksYUFBd0IsQ0FBQztBQUM3QixJQUFJLGFBQXdCLENBQUM7QUFDN0IsSUFBSSxlQUEwQixDQUFDO0FBRS9CLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtJQUM3QixPQUFPO1FBQ0wsa0JBQWtCLEVBQUUsQ0FBQyxNQUFXLEVBQUUsRUFBRSxDQUFDLE1BQU07S0FDNUMsQ0FBQTtBQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0gsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO0lBQzdCLE9BQU87UUFDTCxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsQ0FBQztLQUNyQyxDQUFBO0FBQ0gsQ0FBQyxDQUFDLENBQUE7QUFDRixJQUFJLENBQUMsSUFBSSxDQUFDLDBCQUEwQixFQUFFLEdBQUcsRUFBRTtJQUN6QyxPQUFPO1FBQ0wsY0FBYyxFQUFFLFVBQVUsTUFBVyxJQUFJLE9BQU8sYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4RSxjQUFjLEVBQUUsVUFBVSxNQUFXLElBQUksT0FBTyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hFLFlBQVksRUFBRSxVQUFVLE1BQVcsSUFBSSxPQUFPLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEUsY0FBYyxFQUFFO1lBQ2QsT0FBTztnQkFDTCxJQUFJLEVBQUUsQ0FBQyxPQUFZLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7YUFDekMsQ0FBQTtRQUNILENBQUM7S0FD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QUNILE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMzQyxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQywyREFBMkQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUMzRSxLQUFLLENBQUMsY0FBYyxDQUFDLFlBQVksR0FBRyxRQUFRLENBQUE7UUFDNUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFBO1FBQ3ZDLE9BQU8sQ0FBQyxlQUFlLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBRSxPQUFPLENBQUUsRUFBRSxDQUFDLENBQUM7UUFFaEQsTUFBTSxNQUFNLENBQUMsSUFBQSxVQUFPLEVBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO1lBQzVDLFVBQVUsRUFBRSxHQUFHO1lBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBRSxPQUFPLENBQUUsQ0FBQztTQUNsQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsb0JBQW9CLENBQUM7WUFDM0MsU0FBUyxFQUFFLE9BQU87WUFDbEIseUJBQXlCLEVBQUU7Z0JBQ3pCLEtBQUssRUFBRSxFQUFFLENBQUMsRUFBRSxXQUFXLEVBQUU7YUFDMUI7WUFDRCxzQkFBc0IsRUFBRSxVQUFVO1NBQ25DLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUMxQyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQgfSBmcm9tIFwiYXdzLWxhbWJkYVwiO1xuaW1wb3J0IHsgaGFuZGxlciB9IGZyb20gXCIuXCI7XG5pbXBvcnQgeyBHYW1lREFPLCBHYW1lRFRPIH0gZnJvbSBcIkBncmlkLXdvbGYvc2hhcmVkL2RvbWFpblwiO1xuaW1wb3J0IHsgRW52aXJvbm1lbnRWYXJpYWJsZU5hbWUgfSBmcm9tIFwiQGdyaWQtd29sZi9zaGFyZWQvdXRpbHNcIjtcblxubGV0IHNlbmRTcHk6IGplc3QuTW9jaztcbmxldCBwdXRDb21tYW5kU3B5OiBqZXN0Lk1vY2s7XG5sZXQgZ2V0Q29tbWFuZFNweTogamVzdC5Nb2NrO1xubGV0IHF1ZXJ5Q29tbWFuZFNweTogamVzdC5Nb2NrO1xuXG5qZXN0Lm1vY2soJ2F3cy14cmF5LXNkaycsICgpID0+IHtcbiAgcmV0dXJuIHtcbiAgICBjYXB0dXJlQVdTdjNDbGllbnQ6IChjbGllbnQ6IGFueSkgPT4gY2xpZW50XG4gIH1cbn0pO1xuamVzdC5tb2NrKCdqc29ud2VidG9rZW4nLCAoKSA9PiB7XG4gIHJldHVybiB7XG4gICAgZGVjb2RlOiAoKSA9PiAoeyB1c2VybmFtZTogJ3VzZXInIH0pXG4gIH1cbn0pXG5qZXN0Lm1vY2soJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYicsICgpID0+IHtcbiAgcmV0dXJuIHtcbiAgICBQdXRJdGVtQ29tbWFuZDogZnVuY3Rpb24gKHBhcmFtczogYW55KSB7IHJldHVybiBwdXRDb21tYW5kU3B5KHBhcmFtcyk7IH0sXG4gICAgR2V0SXRlbUNvbW1hbmQ6IGZ1bmN0aW9uIChwYXJhbXM6IGFueSkgeyByZXR1cm4gZ2V0Q29tbWFuZFNweShwYXJhbXMpOyB9LFxuICAgIFF1ZXJ5Q29tbWFuZDogZnVuY3Rpb24gKHBhcmFtczogYW55KSB7IHJldHVybiBxdWVyeUNvbW1hbmRTcHkocGFyYW1zKTsgfSxcbiAgICBEeW5hbW9EQkNsaWVudDogZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc2VuZDogKGNvbW1hbmQ6IGFueSkgPT4gc2VuZFNweShjb21tYW5kKVxuICAgICAgfVxuICAgIH0sXG4gIH1cbn0pO1xuXG5kZXNjcmliZSgnZ2FtZSBoYW5kbGVyJywgKCkgPT4ge1xuICBsZXQgb2xkQ29uc29sZTogQ29uc29sZTtcbiAgbGV0IEF1dGhvcml6YXRpb246IHN0cmluZztcbiAgbGV0IGdhbWVEVE86IEdhbWVEVE87XG4gIGxldCBnYW1lREFPOiBHYW1lREFPO1xuICBsZXQgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50O1xuXG4gIGJlZm9yZUFsbCgoKSA9PiB7XG4gICAgb2xkQ29uc29sZSA9IHsgLi4uY29uc29sZSB9O1xuICAgIGNvbnNvbGUud2FybiA9IChtZXNzYWdlOiBzdHJpbmcpID0+IHt9O1xuICB9KTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBzZW5kU3B5ID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHt9KTtcbiAgICBwdXRDb21tYW5kU3B5ID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7fSk7XG4gICAgZ2V0Q29tbWFuZFNweSA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe30pO1xuICAgIHF1ZXJ5Q29tbWFuZFNweSA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe30pO1xuICAgIFxuICAgIHByb2Nlc3MuZW52W0Vudmlyb25tZW50VmFyaWFibGVOYW1lLkRBVEFfVEFCTEVfTkFNRV0gPSAndGFibGUnO1xuICAgIEF1dGhvcml6YXRpb24gPSBgQmVhcmVyIFRPS0VOYDtcbiAgICBnYW1lRFRPID0ge1xuICAgICAgaWQ6ICdpZCcsXG4gICAgICB1c2VySWQ6ICd1c2VyJyxcbiAgICAgIG5hbWU6ICduYW1lJyxcbiAgICAgIHRpbWVzdGFtcDogMTIzNFxuICAgIH07XG4gICAgZ2FtZURBTyA9IHtcbiAgICAgIHBrOiB7IFM6ICd1c2VyI3VzZXInfSxcbiAgICAgIHNrOiB7IFM6ICdnYW1lI2lkJ30sXG4gICAgICBpZDogeyBTOiAnaWQnIH0sXG4gICAgICB1c2VySWQ6IHsgUzogJ3VzZXInIH0sXG4gICAgICBuYW1lOiB7IFM6ICduYW1lJyB9LFxuICAgICAgdGltZXN0YW1wOiB7IE46ICcxMjM0JyB9XG4gICAgfTtcbiAgICBldmVudCA9IHtcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGdhbWVEVE8pLFxuICAgICAgcmVxdWVzdENvbnRleHQ6IHtcbiAgICAgICAgaHR0cE1ldGhvZDogJ1BVVCcsXG4gICAgICAgIHJlc291cmNlUGF0aDogJy9nYW1lJ1xuICAgICAgfSxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgQXV0aG9yaXphdGlvblxuICAgICAgfVxuICAgIH0gYXMgYW55IGFzIEFQSUdhdGV3YXlQcm94eUV2ZW50XG4gIH0pO1xuXG4gIGFmdGVyQWxsKCgpID0+IHtcbiAgICBjb25zb2xlLndhcm4gPSBvbGRDb25zb2xlLndhcm47XG4gIH0pO1xuXG4gIHRlc3QoJy9nYW1lIFBVVCBzaG91bGQgc2F2ZSBnYW1lIGRhdGEgdG8gZHluYW1vZGInLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgZXhwZWN0KGhhbmRsZXIoZXZlbnQpKS5yZXNvbHZlcy50b0VxdWFsKHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMixcbiAgICAgIGJvZHk6ICdhY2NlcHRlZCdcbiAgICB9KTtcbiAgICBleHBlY3QocHV0Q29tbWFuZFNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgVGFibGVOYW1lOiAndGFibGUnLFxuICAgICAgSXRlbTogZ2FtZURBT1xuICAgIH0pO1xuICAgIGV4cGVjdChzZW5kU3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7fSk7XG4gIH0pO1xuXG4gIHRlc3QoJy9nYW1lIFBVVCBzaG91bGQgcmV0dXJuIDQwMSBpZiBBdXRob3JpemVkIHVzZXIgZG9lcyBub3QgbWF0Y2ggcmVxdWVzdCBib2R5IHVzZXInLCBhc3luYyAoKSA9PiB7XG4gICAgZ2FtZURUTy51c2VySWQgPSAnb3RoZXJwZXJzb24nO1xuICAgIGV2ZW50LmJvZHkgPSBKU09OLnN0cmluZ2lmeShnYW1lRFRPKTtcblxuICAgIGV4cGVjdChhd2FpdCBoYW5kbGVyKGV2ZW50KSkudG9FcXVhbCh7XG4gICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICBib2R5OiAnYmFkIHJlcXVlc3QnXG4gICAgfSk7XG5cbiAgICBleHBlY3QocHV0Q29tbWFuZFNweSkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICBleHBlY3Qoc2VuZFNweSkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgfSk7XG5cbiAgdGVzdCgnL2dhbWUve2dhbWVJZH0gR0VUIHNob3VsZCByZXR1cm4gZGF0YSBvYnRhaW5lZCBmcm9tIGR5bmFtb2RiJywgYXN5bmMgKCkgPT4ge1xuICAgIGV2ZW50LnJlcXVlc3RDb250ZXh0Lmh0dHBNZXRob2QgPSAnR0VUJztcbiAgICBldmVudC5yZXF1ZXN0Q29udGV4dC5yZXNvdXJjZVBhdGggPSAnL2dhbWUve2dhbWVJZH0nO1xuICAgIGV2ZW50LnBhdGhQYXJhbWV0ZXJzID0ge1xuICAgICAgZ2FtZUlkOiAnaWQnXG4gICAgfTtcbiAgICBzZW5kU3B5Lm1vY2tSZXR1cm5WYWx1ZSh7IEl0ZW06IGdhbWVEQU8gfSk7XG5cbiAgICBhd2FpdCBleHBlY3QoaGFuZGxlcihldmVudCkpLnJlc29sdmVzLnRvRXF1YWwoe1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoZ2FtZURUTylcbiAgICB9KTtcblxuICAgIGV4cGVjdChnZXRDb21tYW5kU3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICBUYWJsZU5hbWU6ICd0YWJsZScsXG4gICAgICBLZXk6IHtcbiAgICAgICAgcGs6IHsgUzogJ3VzZXIjdXNlcicgfSxcbiAgICAgICAgc2s6IHsgUzogJ2dhbWUjaWQnfVxuICAgICAgfVxuICAgIH0pO1xuICAgIGV4cGVjdChzZW5kU3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7fSk7XG4gIH0pO1xuXG4gIHRlc3QoJy9nYW1lcyBHRVQgc2hvdWxkIHJldHVybiBhIGxpc3Qgb2YgZ2FtZSBkYXRhIGZvciB0aGUgdXNlcicsIGFzeW5jICgpID0+IHtcbiAgICBldmVudC5yZXF1ZXN0Q29udGV4dC5yZXNvdXJjZVBhdGggPSAnL2dhbWVzJ1xuICAgIGV2ZW50LnJlcXVlc3RDb250ZXh0Lmh0dHBNZXRob2QgPSAnR0VUJ1xuICAgIHNlbmRTcHkubW9ja1JldHVyblZhbHVlKHsgSXRlbXM6IFsgZ2FtZURBTyBdIH0pO1xuXG4gICAgYXdhaXQgZXhwZWN0KGhhbmRsZXIoZXZlbnQpKS5yZXNvbHZlcy50b0VxdWFsKHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KFsgZ2FtZURUTyBdKVxuICAgIH0pO1xuICAgIGV4cGVjdChxdWVyeUNvbW1hbmRTcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgIFRhYmxlTmFtZTogJ3RhYmxlJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpwayc6IHsgUzogJ3VzZXIjdXNlcicgfVxuICAgICAgfSxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwayA9IDpwaydcbiAgICB9KTtcbiAgICBleHBlY3Qoc2VuZFNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe30pXG4gIH0pO1xufSk7XG4iXX0=