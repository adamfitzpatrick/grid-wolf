"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const domain_1 = require("@grid-wolf/shared/domain");
const utils_1 = require("@grid-wolf/shared/utils");
const jsonwebtoken_1 = require("jsonwebtoken");
const aws_xray_sdk_1 = require("aws-xray-sdk");
const client = (0, aws_xray_sdk_1.captureAWSv3Client)(new client_dynamodb_1.DynamoDBClient());
let TableName;
const parseAuthToken = (event) => {
    // Auth header is always present because requests are not accepted without it.
    const authHeader = event.headers.Authorization;
    const token = authHeader.replace(/^Bearer\s/, '');
    return (0, jsonwebtoken_1.decode)(token);
};
const handlePutGameOperation = async (event) => {
    console.debug({ operationHandled: 'putGame' });
    const gameDTO = JSON.parse(event.body);
    const { username } = parseAuthToken(event);
    if (username !== gameDTO.userId) {
        console.warn(`Username mismatch: auth user is ${username}, but request was for ${gameDTO.userId}`);
        return {
            statusCode: 400,
            body: 'bad request'
        };
    }
    const command = new client_dynamodb_1.PutItemCommand({
        TableName,
        Item: (0, domain_1.marshallToDAO)(gameDTO)
    });
    return client.send(command).then(() => ({
        statusCode: 202,
        body: 'accepted'
    }));
};
const handleGetGameOperation = async (event) => {
    console.debug({ operationHandled: 'getGame' });
    const gameId = event.pathParameters['gameId'];
    const { username } = parseAuthToken(event);
    const command = new client_dynamodb_1.GetItemCommand({
        TableName,
        Key: {
            pk: { S: `user#${username}` },
            sk: { S: `game#${gameId}` }
        }
    });
    const response = await client.send(command);
    return {
        statusCode: 200,
        body: JSON.stringify((0, domain_1.marshallToDTO)(response.Item))
    };
};
const handleGetGamesOperation = async (event) => {
    console.debug({ operationHandled: 'getGames' });
    const { username } = parseAuthToken(event);
    const command = new client_dynamodb_1.QueryCommand({
        TableName,
        ExpressionAttributeValues: {
            ':pk': { S: `user#${username}` }
        },
        KeyConditionExpression: 'pk = :pk'
    });
    const response = await client.send(command);
    return {
        statusCode: 200,
        body: JSON.stringify(response.Items.map(domain_1.marshallToDTO))
    };
};
async function handler(event) {
    console.info(JSON.stringify(event));
    TableName = process.env[utils_1.EnvironmentVariableName.DATA_TABLE_NAME];
    const { resourcePath, httpMethod } = event.requestContext;
    let returnValue = null;
    if (resourcePath === '/game' && httpMethod === 'PUT') {
        returnValue = await handlePutGameOperation(event);
    }
    else if (resourcePath === '/game/{gameId}' && httpMethod === 'GET') {
        returnValue = await handleGetGameOperation(event);
    }
    else if (resourcePath === '/games' && httpMethod === 'GET') {
        returnValue = await handleGetGamesOperation(event);
    }
    else {
        console.error(`No handler to invoke for path ${resourcePath} and method ${httpMethod}`);
    }
    console.debug({ returnValue });
    return returnValue;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQStFQSwwQkFrQkM7QUFqR0QsOERBQXdHO0FBQ3hHLHFEQUEwRjtBQUMxRixtREFBa0U7QUFFbEUsK0NBQWtEO0FBQ2xELCtDQUFrRDtBQUdsRCxNQUFNLE1BQU0sR0FBRyxJQUFBLGlDQUFrQixFQUFDLElBQUksZ0NBQWMsRUFBRSxDQUFDLENBQUM7QUFDeEQsSUFBSSxTQUFpQixDQUFDO0FBRXRCLE1BQU0sY0FBYyxHQUFHLENBQUMsS0FBMkIsRUFBRSxFQUFFO0lBQ3JELDhFQUE4RTtJQUM5RSxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLGFBQWMsQ0FBQztJQUNoRCxNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNsRCxPQUFPLElBQUEscUJBQU0sRUFBQyxLQUFLLENBQWUsQ0FBQztBQUNyQyxDQUFDLENBQUE7QUFFRCxNQUFNLHNCQUFzQixHQUFHLEtBQUssRUFBRSxLQUEyQixFQUFFLEVBQUU7SUFDbkUsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLGdCQUFnQixFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFDL0MsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSyxDQUFZLENBQUM7SUFDbkQsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUUzQyxJQUFJLFFBQVEsS0FBSyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDaEMsT0FBTyxDQUFDLElBQUksQ0FDVixtQ0FBbUMsUUFBUSx5QkFBeUIsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUNyRixDQUFBO1FBQ0QsT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsSUFBSSxFQUFFLGFBQWE7U0FDcEIs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QUFVLEtBQUssS0FBSyxFQUFFLENBQUM7UUFDckUsV0FBVyxHQUFHLE1BQU0sc0JBQXNCLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEQsQ0FBQztTQUFNLElBQUksWUFBWSxLQUFLLFFBQVEsSUFBSSxVQUFVLEtBQUssS0FBSyxFQUFFLENBQUM7UUFDN0QsV0FBVyxHQUFHLE1BQU0sdUJBQXVCLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDckQsQ0FBQztTQUFNLENBQUM7UUFDTixPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxZQUFZLGVBQWUsVUFBVSxFQUFFLENBQUMsQ0FBQTtJQUN6RixDQUFDO0lBQ0QsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUE7SUFDOUIsT0FBTyxXQUFXLENBQUM7QUFDckIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFB1dEl0ZW1Db21tYW5kLCBHZXRJdGVtQ29tbWFuZCwgUXVlcnlDb21tYW5kLCBEeW5hbW9EQkNsaWVudCB9IGZyb20gXCJAYXdzLXNkay9jbGllbnQtZHluYW1vZGJcIjtcbmltcG9ydCB7IEdhbWVEVE8sIEdhbWVEQU8sIG1hcnNoYWxsVG9EQU8sIG1hcnNoYWxsVG9EVE8gfSBmcm9tIFwiQGdyaWQtd29sZi9zaGFyZWQvZG9tYWluXCI7XG5pbXBvcnQgeyBFbnZpcm9ubWVudFZhcmlhYmxlTmFtZSB9IGZyb20gXCJAZ3JpZC13b2xmL3NoYXJlZC91dGlsc1wiO1xuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQgfSBmcm9tIFwiYXdzLWxhbWJkYVwiO1xuaW1wb3J0IHsgZGVjb2RlLCBKd3RQYXlsb2FkIH0gZnJvbSAnanNvbndlYnRva2VuJztcbmltcG9ydCB7IGNhcHR1cmVBV1N2M0NsaWVudCB9IGZyb20gJ2F3cy14cmF5LXNkayc7XG5pbXBvcnQgeyBDYWxsQXBpR2F0ZXdheVJlc3RBcGlFbmRwb2ludFByb3BzIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1zdGVwZnVuY3Rpb25zLXRhc2tzXCI7XG5cbmNvbnN0IGNsaWVudCA9IGNhcHR1cmVBV1N2M0NsaWVudChuZXcgRHluYW1vREJDbGllbnQoKSk7XG5sZXQgVGFibGVOYW1lOiBzdHJpbmc7XG5cbmNvbnN0IHBhcnNlQXV0aFRva2VuID0gKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCkgPT4ge1xuICAvLyBBdXRoIGhlYWRlciBpcyBhbHdheXMgcHJlc2VudCBiZWNhdXNlIHJlcXVlc3RzIGFyZSBub3QgYWNjZXB0ZWQgd2l0aG91dCBpdC5cbiAgY29uc3QgYXV0aEhlYWRlciA9IGV2ZW50LmhlYWRlcnMuQXV0aG9yaXphdGlvbiE7XG4gIGNvbnN0IHRva2VuID0gYXV0aEhlYWRlci5yZXBsYWNlKC9eQmVhcmVyXFxzLywgJycpO1xuICByZXR1cm4gZGVjb2RlKHRva2VuKSBhcyBKd3RQYXlsb2FkO1xufVxuXG5jb25zdCBoYW5kbGVQdXRHYW1lT3BlcmF0aW9uID0gYXN5bmMgKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCkgPT4ge1xuICBjb25zb2xlLmRlYnVnKHsgb3BlcmF0aW9uSGFuZGxlZDogJ3B1dEdhbWUnIH0pO1xuICBjb25zdCBnYW1lRFRPID0gSlNPTi5wYXJzZShldmVudC5ib2R5ISkgYXMgR2FtZURUTztcbiAgY29uc3QgeyB1c2VybmFtZSB9ID0gcGFyc2VBdXRoVG9rZW4oZXZlbnQpO1xuXG4gIGlmICh1c2VybmFtZSAhPT0gZ2FtZURUTy51c2VySWQpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICBgVXNlcm5hbWUgbWlzbWF0Y2g6IGF1dGggdXNlciBpcyAke3VzZXJuYW1lfSwgYnV0IHJlcXVlc3Qgd2FzIGZvciAke2dhbWVEVE8udXNlcklkfWBcbiAgICApXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIGJvZHk6ICdiYWQgcmVxdWVzdCdcbiAgICB9O1xuICB9XG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUHV0SXRlbUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZSxcbiAgICBJdGVtOiBtYXJzaGFsbFRvREFPKGdhbWVEVE8pXG4gIH0pO1xuICByZXR1cm4gY2xpZW50LnNlbmQoY29tbWFuZCkudGhlbigoKSA9PiAoe1xuICAgIHN0YXR1c0NvZGU6IDIwMixcbiAgICBib2R5OiAnYWNjZXB0ZWQnXG4gIH0pKTtcbn1cblxuY29uc3QgaGFuZGxlR2V0R2FtZU9wZXJhdGlvbiA9IGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpID0+IHtcbiAgY29uc29sZS5kZWJ1Zyh7IG9wZXJhdGlvbkhhbmRsZWQ6ICdnZXRHYW1lJyB9KTtcbiAgY29uc3QgZ2FtZUlkID0gZXZlbnQucGF0aFBhcmFtZXRlcnMhWydnYW1lSWQnXTtcbiAgY29uc3QgeyB1c2VybmFtZSB9ID0gcGFyc2VBdXRoVG9rZW4oZXZlbnQpO1xuXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0SXRlbUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZSxcbiAgICBLZXk6IHtcbiAgICAgIHBrOiB7IFM6IGB1c2VyIyR7dXNlcm5hbWV9YCB9LFxuICAgICAgc2s6IHsgUzogYGdhbWUjJHtnYW1lSWR9YCB9XG4gICAgfVxuICB9KTtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjbGllbnQuc2VuZChjb21tYW5kKTtcbiAgcmV0dXJuIHtcbiAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkobWFyc2hhbGxUb0RUTyhyZXNwb25zZS5JdGVtIGFzIGFueSBhcyBHYW1lREFPKSlcbiAgfTtcbn1cblxuY29uc3QgaGFuZGxlR2V0R2FtZXNPcGVyYXRpb24gPSBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KSA9PiB7XG4gIGNvbnNvbGUuZGVidWcoeyBvcGVyYXRpb25IYW5kbGVkOiAnZ2V0R2FtZXMnIH0pO1xuICBjb25zdCB7IHVzZXJuYW1lIH0gPSBwYXJzZUF1dGhUb2tlbihldmVudCk7XG5cbiAgY29uc3QgY29tbWFuZCA9IG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZSxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAnOnBrJzogeyBTOiBgdXNlciMke3VzZXJuYW1lfWB9XG4gICAgfSxcbiAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAncGsgPSA6cGsnXG4gIH0pO1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGNsaWVudC5zZW5kKGNvbW1hbmQpO1xuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSgocmVzcG9uc2UuSXRlbXMgYXMgYW55IGFzIEdhbWVEQU9bXSkubWFwKG1hcnNoYWxsVG9EVE8pKVxuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCkge1xuICBjb25zb2xlLmluZm8oSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcblxuICBUYWJsZU5hbWUgPSBwcm9jZXNzLmVudltFbnZpcm9ubWVudFZhcmlhYmxlTmFtZS5EQVRBX1RBQkxFX05BTUVdITtcbiAgY29uc3QgeyByZXNvdXJjZVBhdGgsIGh0dHBNZXRob2QgfSA9IGV2ZW50LnJlcXVlc3RDb250ZXh0O1xuXG4gIGxldCByZXR1cm5WYWx1ZTogb2JqZWN0IHwgbnVsbCA9IG51bGw7XG4gIGlmIChyZXNvdXJjZVBhdGggPT09ICcvZ2FtZScgJiYgaHR0cE1ldGhvZCA9PT0gJ1BVVCcpIHtcbiAgICByZXR1cm5WYWx1ZSA9IGF3YWl0IGhhbmRsZVB1dEdhbWVPcGVyYXRpb24oZXZlbnQpO1xuICB9IGVsc2UgaWYgKHJlc291cmNlUGF0aCA9PT0gJy9nYW1lL3tnYW1lSWR9JyAmJiBodHRwTWV0aG9kID09PSAnR0VUJykge1xuICAgIHJldHVyblZhbHVlID0gYXdhaXQgaGFuZGxlR2V0R2FtZU9wZXJhdGlvbihldmVudCk7XG4gIH0gZWxzZSBpZiAocmVzb3VyY2VQYXRoID09PSAnL2dhbWVzJyAmJiBodHRwTWV0aG9kID09PSAnR0VUJykge1xuICAgIHJldHVyblZhbHVlID0gYXdhaXQgaGFuZGxlR2V0R2FtZXNPcGVyYXRpb24oZXZlbnQpO1xuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUuZXJyb3IoYE5vIGhhbmRsZXIgdG8gaW52b2tlIGZvciBwYXRoICR7cmVzb3VyY2VQYXRofSBhbmQgbWV0aG9kICR7aHR0cE1ldGhvZH1gKVxuICB9XG4gIGNvbnNvbGUuZGVidWcoeyByZXR1cm5WYWx1ZSB9KVxuICByZXR1cm4gcmV0dXJuVmFsdWU7XG59XG4iXX0=